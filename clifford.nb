(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     16120,        444]
NotebookOptionsPosition[     14775,        415]
NotebookOutlinePosition[     15118,        430]
CellTagsIndexPosition[     15075,        427]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"add", "[", 
   RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"#", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
      RowBox[{"Total", "[", 
       RowBox[{"#", "[", 
        RowBox[{"[", 
         RowBox[{";;", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], "&"}], "/@", 
   RowBox[{"GatherBy", "[", 
    RowBox[{
     RowBox[{"Join", "[", 
      RowBox[{"x", ",", "y"}], "]"}], ",", 
     RowBox[{
      RowBox[{"#", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "&"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.803890113503537*^9, 3.803890118533736*^9}, {
  3.8038901502534995`*^9, 3.8038902127492924`*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"ee914fcb-c344-4e5f-ab63-55eeae752b68"],

Cell[BoxData[
 RowBox[{
  RowBox[{"addlst", "[", "x_List", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Length", "[", "x", "]"}], "\[Equal]", "1"}], ",", 
    RowBox[{"x", "[", 
     RowBox[{"[", "1", "]"}], "]"}], ",", 
    RowBox[{"add", "[", 
     RowBox[{
      RowBox[{"addlst", "[", 
       RowBox[{"x", "[", 
        RowBox[{"[", 
         RowBox[{";;", 
          RowBox[{"-", "2"}]}], "]"}], "]"}], "]"}], ",", 
      RowBox[{"x", "[", 
       RowBox[{"[", 
        RowBox[{"-", "1"}], "]"}], "]"}]}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.8039084507928896`*^9, 3.803908456476966*^9}, {
  3.8039087762283573`*^9, 3.8039087815370626`*^9}, {3.8039088553473835`*^9, 
  3.803908869780324*^9}, {3.803909059501017*^9, 3.8039090775738897`*^9}, {
  3.8039128108619084`*^9, 3.8039128109535136`*^9}, {3.80392951232812*^9, 
  3.803929514269039*^9}, {3.803929545167917*^9, 3.8039295481304865`*^9}, {
  3.8039299105555944`*^9, 3.8039299141061335`*^9}, {3.803930240430627*^9, 
  3.8039302405508566`*^9}, {3.8039316967367907`*^9, 3.8039316968744555`*^9}, {
  3.8039317769695435`*^9, 3.803931840731324*^9}},
 CellLabel->"In[39]:=",ExpressionUUID->"997179fc-41ac-4ae6-b84c-a36f2ad0764f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"multlst", "[", 
   RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
  RowBox[{"addlst", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"mult", "[", 
      RowBox[{
       RowBox[{"#", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"#", "[", 
        RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], "/@", 
    RowBox[{"Tuples", "[", 
     RowBox[{"{", 
      RowBox[{"x", ",", "y"}], "}"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mult", "[", 
   RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
  RowBox[{"reduce", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Join", "[", 
      RowBox[{
       RowBox[{"x", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"y", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"x", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "*", 
      RowBox[{"y", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.8038903364114933`*^9, 3.8038903737452116`*^9}, {
  3.8038904348982415`*^9, 3.803890457889306*^9}, {3.803890542387858*^9, 
  3.80389060490808*^9}, {3.8038906528889036`*^9, 3.8038906653698177`*^9}, {
  3.803908308204673*^9, 3.8039083090604935`*^9}, {3.8039294222815666`*^9, 
  3.8039294328171577`*^9}, {3.803930003195033*^9, 3.803930003915577*^9}},
 CellLabel->"In[3]:=",ExpressionUUID->"729db647-37b9-4e03-a394-acce3f700b05"],

Cell[BoxData[
 RowBox[{
  RowBox[{"reduce", "[", "x_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"pairs", ",", "sel", ",", "y", ",", "spl", ",", "mult3"}], "}"}],
     ",", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"pairs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"i", ",", "j"}], "}"}], ",", 
              RowBox[{"x", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "i"}], "]"}], "]"}], ",", 
              RowBox[{"x", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "j"}], "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", 
              RowBox[{"Length", "@", 
               RowBox[{"x", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "i", ",", 
              RowBox[{"Length", "@", 
               RowBox[{"x", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}]}], "}"}]}], "]"}], ",", 
          "1"}], "]"}]}], ";", 
       RowBox[{"sel", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"pairs", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "2", "]"}], "]"}], ">", 
            RowBox[{"#", "[", 
             RowBox[{"[", "3", "]"}], "]"}]}], "&"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"y", "=", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "sel", "]"}], "\[Equal]", "0"}], ",", 
          RowBox[{"{", "x", "}"}], ",", 
          RowBox[{"addlst", "[", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"reduce", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Delete", "[", 
                 RowBox[{
                  RowBox[{"x", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"sel", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "}"}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{"sel", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1", ",", "2"}], "]"}], "]"}], "}"}]}], 
                   "}"}]}], "]"}], ",", 
                RowBox[{"-", 
                 RowBox[{"x", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "]"}], ",", 
             RowBox[{"reduce", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Permute", "[", 
                 RowBox[{
                  RowBox[{"x", "[", 
                   RowBox[{"[", "1", "]"}], "]"}], ",", 
                  RowBox[{"Cycles", "[", 
                   RowBox[{"{", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"sel", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], ",", 
                    RowBox[{"sel", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1", ",", "2"}], "]"}], "]"}]}], "}"}], 
                    "}"}], "]"}]}], "]"}], ",", 
                RowBox[{"-", 
                 RowBox[{"x", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "]"}]}], "}"}], 
           "]"}]}], "]"}]}]}], ")"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"spl", "=", 
         RowBox[{"Split", "[", 
          RowBox[{
           RowBox[{"y", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"mult3", "=", 
         RowBox[{"Total", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Floor", "[", 
             RowBox[{
              RowBox[{"Length", "[", "#", "]"}], "/", "2"}], "]"}], "&"}], "/@",
            "spl"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{"spl", ",", 
             RowBox[{
              RowBox[{
               RowBox[{"Mod", "[", 
                RowBox[{
                 RowBox[{"Length", "[", "#", "]"}], ",", "2"}], "]"}], 
               "\[Equal]", "1"}], "&"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{";;", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{"-", "1"}], ")"}], "mult3"], "*", 
           RowBox[{
            RowBox[{"y", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "[", 
            RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", 
         RowBox[{"Length", "@", "y"}]}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.8038906688556085`*^9, 3.8038906946453543`*^9}, {
   3.8039056679068713`*^9, 3.803905713626134*^9}, {3.803905864841631*^9, 
   3.8039058874429083`*^9}, 3.803905943333372*^9, {3.8039060072030907`*^9, 
   3.803906012577672*^9}, {3.8039060584508314`*^9, 3.803906200224425*^9}, {
   3.803906311130705*^9, 3.803906391576342*^9}, {3.8039064822495193`*^9, 
   3.803906539246225*^9}, {3.8039066110709496`*^9, 3.8039066324192452`*^9}, {
   3.803906678138525*^9, 3.803906765894083*^9}, {3.8039068258828497`*^9, 
   3.8039068335797825`*^9}, {3.803906914992051*^9, 3.803906971209936*^9}, {
   3.803907098865036*^9, 3.8039071663720818`*^9}, {3.8039074961713395`*^9, 
   3.803907573958849*^9}, {3.8039076556267157`*^9, 3.8039077766355577`*^9}, {
   3.803907913279182*^9, 3.8039079334684706`*^9}, {3.8039079910950823`*^9, 
   3.803908000755599*^9}, {3.803908050213934*^9, 3.8039080816173267`*^9}, {
   3.8039300216202507`*^9, 3.803930022247729*^9}, {3.8039306517615595`*^9, 
   3.80393066671564*^9}, {3.8039307984114175`*^9, 3.803930819217548*^9}, {
   3.803930882956664*^9, 3.8039308854458456`*^9}, {3.803931096946006*^9, 
   3.803931130572344*^9}, 3.8039313343026695`*^9, {3.8039315171086354`*^9, 
   3.803931517653162*^9}, {3.803931997131215*^9, 3.8039320771257844`*^9}, {
   3.8039321417772503`*^9, 3.8039321543858986`*^9}, 3.803932225608038*^9},
 CellLabel->"In[69]:=",ExpressionUUID->"73981d2b-5a73-4d24-b00d-10dcc786c1de"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"addlst", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "2"}], "}"}], ",", "1"}], "}"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}], ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", "1"}], "}"}]}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.803931730988267*^9, 3.8039317710388165`*^9}, {
  3.8039318450979295`*^9, 
  3.8039318463563976`*^9}},ExpressionUUID->"0507f805-947c-4602-adf5-\
a67775b5cd2d"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "2"}], "}"}], ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", "1", "}"}], ",", "1"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.8039317505036745`*^9, 3.803931772907686*^9}},
 CellLabel->"Out[38]=",ExpressionUUID->"b71d23d8-7be5-4cfa-aaa1-ffd09a167ffa"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"addlst", "[", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", "1"}], "}"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", "1"}], "}"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", "2", "}"}], ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "2"}], "}"}], ",", "1"}], "}"}]}], "}"}]}], "}"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.803931848544814*^9, 3.8039318961206684`*^9}},
 CellLabel->"In[72]:=",ExpressionUUID->"2fff4673-2da9-4b63-abb5-0efdb850b429"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", "1", "}"}], ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", "2", "}"}], ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "2"}], "}"}], ",", "1"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.8039318763913927`*^9, 3.8039318965924473`*^9}, 
   3.803932237445759*^9},
 CellLabel->"Out[72]=",ExpressionUUID->"3bff412b-1cdc-4ea9-ace2-878d9d594a28"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"multlst", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "3", "}"}], ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1", ",", "2", ",", "3"}], "}"}], ",", "1"}], "}"}]}], "}"}], 
   ",", 
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "3", "}"}], ",", "1"}], "}"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.803931924687189*^9, 3.8039319391922626`*^9}, {
  3.8039319770089703`*^9, 3.803931977722185*^9}, {3.803932023075902*^9, 
  3.80393202400344*^9}, {3.803932232188614*^9, 3.8039322844219255`*^9}},
 CellLabel->"In[77]:=",ExpressionUUID->"d0360d3a-3fea-47eb-a931-70efeb63cb18"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "3"}], "}"}], ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", "}"}], ",", 
     RowBox[{"-", "1"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "2"}], "}"}], ",", 
     RowBox[{"-", "1"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.803931935465247*^9, 3.8039319398116984`*^9}, 
   3.8039319781535673`*^9, {3.8039320188161163`*^9, 3.8039320916018496`*^9}, 
   3.803932158231391*^9, {3.8039322294241157`*^9, 3.803932285017764*^9}},
 CellLabel->"Out[77]=",ExpressionUUID->"98712e6d-4953-4676-8ddd-1efc9827ae34"]
}, Open  ]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{3.803931930329709*^9, 
  3.803932296138831*^9},ExpressionUUID->"d5b360ea-24ce-410a-ab2e-\
703c0baaa21b"]
},
WindowSize->{1536, 781},
WindowMargins->{{-8, Automatic}, {Automatic, -8}},
FrontEndVersion->"11.3 for Microsoft Windows (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 818, 24, 28, "Input",ExpressionUUID->"ee914fcb-c344-4e5f-ab63-55eeae752b68"],
Cell[1379, 46, 1221, 27, 28, "Input",ExpressionUUID->"997179fc-41ac-4ae6-b84c-a36f2ad0764f"],
Cell[2603, 75, 1431, 38, 48, "Input",ExpressionUUID->"729db647-37b9-4e03-a394-acce3f700b05"],
Cell[4037, 115, 6672, 161, 180, "Input",ExpressionUUID->"73981d2b-5a73-4d24-b00d-10dcc786c1de"],
Cell[CellGroupData[{
Cell[10734, 280, 633, 20, 28, "Input",ExpressionUUID->"0507f805-947c-4602-adf5-a67775b5cd2d"],
Cell[11370, 302, 397, 11, 32, "Output",ExpressionUUID->"b71d23d8-7be5-4cfa-aaa1-ffd09a167ffa"]
}, Open  ]],
Cell[CellGroupData[{
Cell[11804, 318, 727, 23, 28, "Input",ExpressionUUID->"2fff4673-2da9-4b63-abb5-0efdb850b429"],
Cell[12534, 343, 510, 15, 32, "Output",ExpressionUUID->"3bff412b-1cdc-4ea9-ace2-878d9d594a28"]
}, Open  ]],
Cell[CellGroupData[{
Cell[13081, 363, 824, 23, 28, "Input",ExpressionUUID->"d0360d3a-3fea-47eb-a931-70efeb63cb18"],
Cell[13908, 388, 698, 19, 32, "Output",ExpressionUUID->"98712e6d-4953-4676-8ddd-1efc9827ae34"]
}, Open  ]],
Cell[14621, 410, 150, 3, 28, "Input",ExpressionUUID->"d5b360ea-24ce-410a-ab2e-703c0baaa21b"]
}
]
*)

